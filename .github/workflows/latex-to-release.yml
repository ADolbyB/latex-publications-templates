name: LaTeX â†’ PDF Release

on:
  push:
    tags:
      - 'v*'  # Only run when a tag starting with 'v' is pushed (v0.91, v2.3.1, etc.)

permissions:
  contents: write  # Required to create releases and upload release assets

jobs:
  # JOB 1: Compile publication documents in parallel
  compile-publications:
    runs-on: ubuntu-latest
    strategy:   # Matrix strategy allows running the same steps multiple times
      matrix:   # Each item in the matrix runs a separate, parallel job
        publication:
          # 'name' is a friendly identifier, 'dir' is the working directory, 'file' is the .tex file
          - { name: 'HT1000 Radio Primer', dir: 'Publications/Articles/Radio-HT1000', file: '2025_HT1000_ch_guide.tex' }
          - { name: 'From Crisis to Control', dir: 'Publications/Conference/DisasterMgmt', file: 'CrisisToControl.tex' }
          - { name: 'IEEE Backup Template', dir: 'Publications/Conference/Backup', file: 'IEEE-BackupTemplate.tex' }
  
    steps:
      # Step 1: Check out the repository code to access .tex files
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Step 2: Compile the LaTeX documents in parallel
      - name: Compile ${{ matrix.publication.name }}  # Name shows which document is being compiled
        uses: xu-cheng/latex-action@v3
        with:
          root_file: ${{ matrix.publication.file }}        # Each main .tex file to compile
          working_directory: ${{ matrix.publication.dir }} # Directory to run the compilation
      
      # Step 3: Upload the compiled PDF as a temporary artifact
      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: pdf-${{ matrix.publication.name }}    # Unique name for this artifact
          path: ${{ matrix.publication.dir }}/*.pdf   # Path to the compiled PDF
          retention-days: 1  # Delete after 1 day (only needed for this workflow)

  # JOB 2: Compile tutorial documents in parallel
  compile-tutorials:
    runs-on: ubuntu-latest
    strategy:   # Matrix strategy allows running the same steps multiple times
      matrix:   # 16 separate, parallel jobs
        tutorial:
          - { dir: '00a-Tutorial1', file: 'tutorial1.tex' }
          - { dir: '00b-MLACites', file: 'MLABib.tex' }
          - { dir: '00c-UsingBibTex', file: 'BibTexChapters.tex' }
          - { dir: '01-FCC-BasicStructure', file: 'fcc-01-BasicStructure.tex' }
          - { dir: '02-FCC-BasicMath', file: 'fcc-02-BasicMath.tex' }
          - { dir: '03-FCC-TablesArrays', file: 'fcc-03.tex' }
          - { dir: '04-FCC-Lists', file: 'fcc-04.tex' }
          - { dir: '05-FCC-Formatting', file: 'fcc-05.tex' }
          - { dir: '06-FCC-MacrosGraphics', file: 'fcc-06.tex' }
          - { dir: '07-FCC-Debugging', file: 'fcc-07.tex' }
          - { dir: '08-FCC-Calculus', file: 'fcc-08.tex' }
          - { dir: '09-FCC-MathPaper', file: 'fcc-09.tex' }
          - { dir: '10-FCC-BeamerPPT', file: 'beamer-tut.tex' }
          - { dir: '11a-IEEE-Conference', file: 'conference_101719.tex' }
          - { dir: '11b-IEEE-withBib', file: 'IEEE-JB.tex' }
          - { dir: '13-imageFlipping', file: 'imageFlip.tex' }
          # Tutorial 12 (LabelError.tex) is intentionally skipped

    steps:  # runs 16 times in parallel
      # Step 1: Check out the repository code
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Step 2: Compile the tutorial LaTeX document
      - name: Compile Tutorial ${{ matrix.tutorial.dir }}  # Name of tutorial being compiled
        uses: xu-cheng/latex-action@v3
        with:
          root_file: ${{ matrix.tutorial.file }}           # tex file to compile
          working_directory: Tutorials/${{ matrix.tutorial.dir }}  # Tutorial subdirectory
      
      # Step 3: Upload the compiled tutorial PDF as an artifact
      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: pdf-tutorial-${{ matrix.tutorial.dir }}  # Unique artifact name for each tutorial
          path: Tutorials/${{ matrix.tutorial.dir }}/*.pdf  # Path to compiled PDF
          retention-days: 1

  # JOB 3: Create the GitHub release and upload all compiled PDFs
  create-release:
    # This job needs to wait for both compilation jobs to finish
    needs: [compile-publications, compile-tutorials]
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Check out the repository (needed for directory structure)
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Step 2: Download all the PDF artifacts created by the previous jobs
      - name: Download all publication PDFs
        uses: actions/download-artifact@v4  # Official action for downloading artifacts
        with:
          pattern: pdf-*  # Download all artifacts that start with "pdf-"
          path: compiled-pdfs  # Download everything into this directory
          merge-multiple: true  # Merge all artifacts into a single directory
      
      # Step 3: Recreate the original repo structure so the files are in expected locations
      - name: Organize PDFs
        run: |
          mkdir -p Publications/Articles/Radio-HT1000
          mkdir -p Publications/Conference/Backup
          mkdir -p Publications/Conference/DisasterMgmt
          mkdir -p Tutorials

          find compiled-pdfs -name "2025_HT1000_ch_guide.pdf" -exec cp {} Publications/Articles/Radio-HT1000/ \;
          find compiled-pdfs -name "IEEE-BackupTemplate.pdf" -exec cp {} Publications/Conference/Backup/ \;
          find compiled-pdfs -name "CrisisToControl.pdf" -exec cp {} Publications/Conference/DisasterMgmt/ \;
          find compiled-pdfs -name "*.pdf" ! -name "2025_HT1000_ch_guide.pdf" ! -name "IEEE-BackupTemplate.pdf" ! -name "CrisisToControl.pdf" -exec cp {} Tutorials/ \;
      
      # Step 4: Create a ZIP archive containing all Tutorial PDFs
      - name: Create Tutorials ZIP archive
        run: |
          cd Tutorials
          zip -j ../TutorialsAllPDFs.zip *.pdf 2>/dev/null || true
      
      # Step 5: Create the GitHub release and upload all assets
      - name: Create Release & Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}      # "v1.0.0, etc."
          name: Release ${{ github.ref_name }}  # Title shown on the release page
          draft: false
          prerelease: false
          generate_release_notes: false
          
          # Custom release description using markdown. The pipe '|' allows multi-line text
          body: |
            ðŸ“š LaTeX Publications & Tutorials - Release ${{ github.ref_name }}
      
            This release contains compiled PDFs from LaTeX source files:
      
            **Publications:**
            - ðŸ“„ HT1000 Radio Primer (Article)
            - ðŸ“„ From Crisis To Control (IEEE Conference)
            - ðŸ“„ IEEE Pre-filled Template (IEEE Conference)
      
            **Tutorials:**
            - ðŸ“¦ Complete tutorial collection (ZIP file - 16 tutorials)
      
            Download the source code for all pre-compiled `.tex` files in the repository.
          
          # List of files to attach to the release
          files: |
            Publications/Articles/Radio-HT1000/2025_HT1000_ch_guide.pdf
            Publications/Conference/DisasterMgmt/CrisisToControl.pdf
            Publications/Conference/Backup/IEEE-BackupTemplate.pdf
            TutorialsAllPDFs.zip

          # Fail if anything missing (no incomplete releases)
          fail_on_unmatched_files: true